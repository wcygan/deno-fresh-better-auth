# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

```bash
# Setup
cp .env.example .env
deno install

# Database setup
deno run -A npm:@better-auth/cli@latest generate --output db/auth-schema.ts --yes
deno run -A --env-file --node-modules-dir npm:drizzle-kit generate --name=init
deno run -A --env-file --node-modules-dir npm:drizzle-kit migrate

# Development
deno task dev          # Start development server
deno task db           # Start PostgreSQL container
deno task build        # Production build
deno task start        # Run production server
deno task test         # Run tests with proper env setup
deno task check        # Format, lint, and type check
deno task open         # Open browser to dev server

# Single test execution
deno test tests/auth_signup_test.ts --allow-env --env --env-file=.env --allow-net=127.0.0.1,localhost
```

## Architecture Overview

This is a **Deno Fresh** application with **Better Auth** authentication system using **PostgreSQL** and **Drizzle ORM**.

### Key Components

- **Authentication**: Better Auth with email/password and GitHub OAuth
- **Database**: PostgreSQL with Drizzle ORM adapter
- **Frontend**: Fresh framework with Preact and TailwindCSS
- **Rate Limiting**: Built into Better Auth (3 requests per 10 seconds for sign-in)

### Project Structure

```bash
/routes/           # File-system based routing
  _middleware.ts   # Global middleware
  _app.tsx         # App wrapper
  index.tsx        # Home page
  login.tsx        # Login page

/islands/          # Client-side interactive components
  NavBar.tsx       
  LoginForm.tsx
  Counter.tsx

/utils/            # Shared utilities
  auth.ts          # Better Auth configuration
  auth-factory.ts  # Auth client factory

/db/               # Database layer
  db.ts            # Database connection
  auth-schema.ts   # Generated auth schema
  factory.ts       # Database factory

/tests/            # Test suite
  helpers/         # Test utilities and harness
  auth_*_test.ts   # Authentication flow tests
```

### Authentication Flow

1. Auth routes handled in `main.ts` at `/api/auth/*`
2. Better Auth configuration in `utils/auth.ts` with:
   - Email/password authentication (8 char minimum)
   - GitHub social provider
   - Rate limiting enabled
   - Trusted origins for local development

### Database Setup

- Uses Drizzle Kit for migrations
- Schema auto-generated by Better Auth CLI
- PostgreSQL connection via Docker Compose
- Database credentials in `.env` file

### Testing

Tests include comprehensive authentication flows with:

- Database harness for isolated test runs
- HTTP client helpers
- Cookie handling utilities
- Auth flow helpers for sign up/in/out

### Environment Variables

Required in `.env`:

- `DATABASE_URL`: PostgreSQL connection string
- `BETTER_AUTH_SECRET`: Auth secret key
- `BETTER_AUTH_URL`: Application URL
- `GITHUB_CLIENT_ID`: GitHub OAuth client ID  
- `GITHUB_CLIENT_SECRET`: GitHub OAuth secret